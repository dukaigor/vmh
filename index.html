<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema di registrazione presenze</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #2D2D2C; 
            color: #fff;
        }
        select, button, input { 
            margin: 10px 0; 
            padding: 10px 15px; 
            background-color: #3D3D3C; 
            color: #fff; 
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }
        select {
            width: 100%;
            max-width: 300px;
        }
        button {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #4D4D4C;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            background-color: #3D3D3C;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td { 
            border: 1px solid #4D4D4C; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: #4D4D4C; 
        }
        #adminPanel { 
            display: none; 
            background-color: #3D3D3C;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        #logo {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            display: block;
        }
        .main-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        #accessAdminBtn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #FF3B30;
        }
        #closeAdminBtn {
            background-color: #FF3B30;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="main-controls">
        <select id="worker" name="worker"></select>
        <div class="action-buttons">
            <button onclick="recordAttendance('Entrata')">Entrata</button>
            <button onclick="recordAttendance('Uscita')">Uscita</button>
        </div>
    </div>
    
    <button id="accessAdminBtn" onclick="accessAdminPanel()">Accesso Admin</button>
    
    <div id="adminPanel">
        <button id="closeAdminBtn" onclick="closeAdminPanel()">Chiudi Pannello Admin</button>
        <h3>Pannello di amministrazione</h3>
        <input type="text" id="newWorker" placeholder="Nome nuovo lavoratore">
        <button onclick="addWorker()">Aggiungi lavoratore</button>
        <br>
        <select id="workerToRemove"></select>
        <button onclick="removeWorker()">Rimuovi lavoratore</button>
        <br>
        <button onclick="downloadCSV()">Scarica tabella (CSV)</button>
        
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Azione</th>
                    <th>Data e Ora</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Ore lavorate per mese</h3>
        <table id="hoursWorkedTable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Mese</th>
                    <th>Ore lavorate</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <img id="logo" src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202024-07-08%20%D0%B2%2017.39.20-ZoYKfLDx1Dk5H5AP2lXNvUbWo9Ifdi.png" alt="Valery Mystic Hair Logo">

    <script>
        let workers = ['Olesea', 'Martina', 'Cristina', 'Veronica', 'Inga', 'Vlada'];
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];

        function updateWorkerSelects() {
            const workerSelect = document.getElementById('worker');
            const workerToRemoveSelect = document.getElementById('workerToRemove');
            workerSelect.innerHTML = '';
            workerToRemoveSelect.innerHTML = '';
            workers.forEach(worker => {
                workerSelect.add(new Option(worker, worker));
                workerToRemoveSelect.add(new Option(worker, worker));
            });
        }

        function recordAttendance(action) {
            const worker = document.getElementById('worker').value;
            const timestamp = new Date().toLocaleString('it-IT');
            attendanceData.push({ worker, action, timestamp });
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            alert(`Azione registrata: ${worker} - ${action}`);
            updateAttendanceTable();
            updateHoursWorkedTable();
        }

        function updateAttendanceTable() {
            const tableBody = document.querySelector('#attendanceTable tbody');
            tableBody.innerHTML = '';
            attendanceData.forEach(record => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = record.worker;
                row.insertCell(1).textContent = record.action;
                row.insertCell(2).textContent = record.timestamp;
            });
        }

        function accessAdminPanel() {
            const password = prompt("Inserisci la password di admin:");
            if (password === '1309') {
                document.getElementById('adminPanel').style.display = 'block';
                updateAttendanceTable();
                updateHoursWorkedTable();
            } else {
                alert('Password non corretta');
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        function addWorker() {
            const newWorker = document.getElementById('newWorker').value.trim();
            if (newWorker && !workers.includes(newWorker)) {
                workers.push(newWorker);
                localStorage.setItem('workers', JSON.stringify(workers));
                updateWorkerSelects();
                document.getElementById('newWorker').value = '';
                alert(`Il lavoratore ${newWorker} è stato aggiunto.`);
            } else {
                alert('Il nome del lavoratore non è valido o esiste già.');
            }
        }

        function removeWorker() {
            const workerToRemove = document.getElementById('workerToRemove').value;
            if (workerToRemove && confirm(`Sei sicuro di voler rimuovere il lavoratore ${workerToRemove}?`)) {
                workers = workers.filter(w => w !== workerToRemove);
                localStorage.setItem('workers', JSON.stringify(workers));
                attendanceData = attendanceData.filter(record => record.worker !== workerToRemove);
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                updateWorkerSelects();
                updateAttendanceTable();
                updateHoursWorkedTable();
                alert(`Il lavoratore ${workerToRemove} è stato rimosso.`);
            }
        }

        function downloadCSV() {
            let csv = 'Nome,Azione,Data e Ora\n';
            attendanceData.forEach(record => {
                csv += `"${record.worker}","${record.action}","${record.timestamp}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'registro_presenze.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function updateHoursWorkedTable() {
            const workerHours = {};

            attendanceData.forEach(record => {
                const recordDate = new Date(record.timestamp);
                const monthYear = `${recordDate.getMonth() + 1}/${recordDate.getFullYear()}`;
                
                if (!workerHours[record.worker]) {
                    workerHours[record.worker] = {};
                }
                if (!workerHours[record.worker][monthYear]) {
                    workerHours[record.worker][monthYear] = { lastEntry: null, totalHours: 0 };
                }

                if (record.action === 'Entrata') {
                    workerHours[record.worker][monthYear].lastEntry = recordDate;
                } else if (record.action === 'Uscita' && workerHours[record.worker][monthYear].lastEntry) {
                    const hoursWorked = (recordDate - workerHours[record.worker][monthYear].lastEntry) / (1000 * 60 * 60);
                    workerHours[record.worker][monthYear].totalHours += hoursWorked;
                    workerHours[record.worker][monthYear].lastEntry = null;
                }
            });

            const tableBody = document.querySelector('#hoursWorkedTable tbody');
            tableBody.innerHTML = '';
            for (const [worker, months] of Object.entries(workerHours)) {
                for (const [month, data] of Object.entries(months)) {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = worker;
                    row.insertCell(1).textContent = month;
                    row.insertCell(2).textContent = data.totalHours.toFixed(2);
                }
            }
        }

        updateWorkerSelects();
        updateAttendanceTable();
        updateHoursWorkedTable();
    </script>
</body>
</html>
