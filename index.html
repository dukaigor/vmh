<!DOCTYPE html>
<html lang="it">
<head>
    <!-- Codul pentru head rămâne neschimbat -->
</head>
<body>
    <!-- Codul pentru structura HTML rămâne neschimbat -->

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA6E5Xn5RvZViYJW-hxh3pn8w1ALDZpOb4",
            authDomain: "vmh-tracker.firebaseapp.com",
            databaseURL: "https://vmh-tracker-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "vmh-tracker",
            storageBucket: "vmh-tracker.appspot.com",
            messagingSenderId: "1036108389148",
            appId: "1:1036108389148:web:2add2da83a2759913138d9"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let workers = [];
        let attendanceData = [];

        function updateWorkerSelects() {
            const workerSelects = ['worker', 'workerToEdit', 'workerToRemove', 'workerForManualEntry'];
            workerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                workers.forEach(worker => {
                    select.add(new Option(worker, worker));
                });
            });
        }

        function checkAttendanceForToday(worker, currentDate) {
            const todayEntries = attendanceData.filter(record => 
                record.worker === worker && 
                new Date(record.timestamp).toDateString() === currentDate.toDateString()
            );
            return {
                hasEntrata: todayEntries.some(entry => entry.action === 'Entrata'),
                hasUscita: todayEntries.some(entry => entry.action === 'Uscita')
            };
        }

        function showMessage(message) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 4000);
        }

        function recordAttendance(action) {
            const worker = document.getElementById('worker').value;
            const note = document.getElementById('note').value;
            const currentDate = new Date();
            const timestamp = currentDate.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const todayAttendance = checkAttendanceForToday(worker, currentDate);

            if (action === 'Entrata' && todayAttendance.hasEntrata) {
                showMessage(`Attenzione: ${worker} ha già registrato un'entrata oggi.`);
                return;
            }

            if (action === 'Uscita') {
                if (!todayAttendance.hasEntrata) {
                    showMessage(`Attenzione: ${worker} non ha registrato un'entrata oggi.`);
                    return;
                }
                if (todayAttendance.hasUscita) {
                    showMessage(`Attenzione: ${worker} ha già registrato un'uscita oggi.`);
                    return;
                }
            }

            const newRecord = { worker, action, timestamp, note };
            database.ref('attendance').push(newRecord);
            document.getElementById('note').value = '';

            if (action === 'Entrata') {
                showMessage('Benvenuto al lavoro!');
            } else {
                showMessage('Ciao, è una bella giornata!');
            }
        }

        function manualEntry() {
            const worker = document.getElementById('workerForManualEntry').value;
            const dateTime = document.getElementById('manualEntryDateTime').value;
            const action = document.getElementById('manualEntryAction').value;
            const note = document.getElementById('manualEntryNote').value;

            if (!worker || !dateTime)  {
                showMessage('Per favore, compila tutti i campi obbligatori.');
                return;
            }

            const entryDate = new Date(dateTime);
            const todayAttendance = checkAttendanceForToday(worker, entryDate);

            if (action === 'Entrata' && todayAttendance.hasEntrata) {
                showMessage(`Attenzione: ${worker} ha già registrato un'entrata in questa data.`);
                return;
            }

            if (action === 'Uscita') {
                if (!todayAttendance.hasEntrata) {
                    showMessage(`Attenzione: ${worker} non ha registrato un'entrata in questa data.`);
                    return;
                }
                if (todayAttendance.hasUscita) {
                    showMessage(`Attenzione: ${worker} ha già registrato un'uscita in questa data.`);
                    return;
                }
            }

            const timestamp = entryDate.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const newRecord = { worker, action, timestamp, note };
            database.ref('attendance').push(newRecord);
            showMessage('Registrazione manuale inserita con successo.');

            // Reset form
            document.getElementById('manualEntryDateTime').value = '';
            document.getElementById('manualEntryNote').value = '';
        }

        // Restul funcțiilor rămân neschimbate

        database.ref('workers').on('value', snapshot => {
            workers = snapshot.val() ? Object.values(snapshot.val()) : [];
            updateWorkerSelects();
        });

        database.ref('attendance').on('value', snapshot => {
            attendanceData = snapshot.val() ? Object.entries(snapshot.val()).map(([id, data]) => ({id, ...data})) : [];
            updateAttendanceTable();
            updateHoursWorkedTable();
        });

        // Codul pentru service worker și instalare PWA rămâne neschimbat
    </script>
</body>
</html>
